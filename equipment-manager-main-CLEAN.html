<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¢×¨×›×ª ×œ× ×™×”×•×œ ×§×©×¨ ×¤×œ×•×’×ª×™</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .header { background: white; padding: 20px; border-bottom: 4px solid #2c5f2d; display: flex; align-items: center; gap: 20px; border-radius: 8px; margin-bottom: 20px; }
        .logo { width: 80px; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 5px; font-weight: bold; }
        .nav-btn.active { background: #2c5f2d; color: white; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        thead { background: #2c5f2d; color: white; }
        .editable { cursor: pointer; transition: 0.2s; }
        .editable:hover { background: #fff9c4; }
        .btn { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #d32f2f; color: white; }
        .report-preview { background: #f9f9f9; padding: 20px; border-radius: 5px; border: 1px solid #ccc; white-space: pre-wrap; direction: rtl; text-align: right; }
        .fault-card { background: #fff3e0; border-right: 5px solid #ff9800; padding: 15px; border-radius: 5px; margin-bottom: 10px; text-align: right; }
        .fault-resolved { background: #e8f5e9; border-right-color: #4caf50; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const UNITS = ['××—×œ×§×” 1', '××—×œ×§×” 2', '××—×œ×§×” 3', '×—×¤×§', '×—××œ', '××¤×œ×’'];
        const FB_URL = "https://plugat-kaf-default-rtdb.firebaseio.com";

        const storage = {
            save: async (key, data) => await fetch(`${FB_URL}/${key}.json`, { method: 'PUT', body: JSON.stringify(data) }),
            load: async (key) => {
                const r = await fetch(`${FB_URL}/${key}.json`);
                const d = await r.json();
                return d ? (Array.isArray(d) ? d : Object.values(d)) : [];
            }
        };

        function App() {
            const [view, setView] = useState('dashboard');
            const [checkouts, setCheckouts] = useState([]);
            const [faults, setFaults] = useState([]);
            const [isSyncing, setIsSyncing] = useState(false);

            const loadData = useCallback(async () => {
                if (isSyncing) return;
                const [c, f] = await Promise.all([storage.load('checkouts'), storage.load('faults')]);
                setCheckouts(c); setFaults(f);
            }, [isSyncing]);

            useEffect(() => { loadData(); const i = setInterval(loadData, 5000); return () => clearInterval(i); }, [loadData]);

            const onUpdate = async (id, field, val) => {
                setIsSyncing(true);
                const updated = checkouts.map(c => c.id === id ? { ...c, [field]: val } : c);
                setCheckouts(updated); await storage.save('checkouts', updated);
                setIsSyncing(false);
            };

            const toggleEquip = async (id, equip) => {
                setIsSyncing(true);
                const updated = checkouts.map(c => {
                    if (c.id === id) {
                        const eq = c.equipment || {};
                        return { ...c, equipment: { ...eq, [equip]: !eq[equip] } };
                    }
                    return c;
                });
                setCheckouts(updated); await storage.save('checkouts', updated);
                setIsSyncing(false);
            };

            const onFaultStatus = async (fid, status) => {
                setIsSyncing(true);
                const updated = faults.map(f => f.id === fid ? { ...f, status, resolvedDate: status === 'resolved' ? new Date().toISOString() : null } : f);
                setFaults(updated); await storage.save('faults', updated);
                setIsSyncing(false);
            };

            return (
                <div>
                    <div className="header">
                        <img src="https://i.ibb.co/L9YmNfW/image.png" className="logo" alt="logo" />
                        <div><h1 style={{margin:0}}>×¤×œ×•×’×” ×›×³ ×’×“×•×“ 43</h1><p style={{margin:0}}>××¢×¨×›×ª ×œ× ×™×”×•×œ ×§×©×¨ ×¤×œ×•×’×ª×™</p></div>
                    </div>
                    <div className="nav">
                        <button className={`nav-btn ${view === 'dashboard' ? 'active' : ''}`} onClick={() => setView('dashboard')}>×œ×•×— ×‘×§×¨×”</button>
                        <button className={`nav-btn ${view === 'faults' ? 'active' : ''}`} onClick={() => setView('faults')}>×ª×§×œ×•×ª ({faults.filter(f => f.status === 'pending').length})</button>
                        <button className={`nav-btn ${view === 'report' ? 'active' : ''}`} onClick={() => setView('report')}>×“×•×— ×™×•××™</button>
                        <button className={`nav-btn ${view === 'links' ? 'active' : ''}`} onClick={() => setView('links')}>×§×™×©×•×¨×™×</button>
                    </div>
                    <main className="section">
                        {view === 'dashboard' && <Dashboard checkouts={checkouts} onUpdate={onUpdate} onToggle={toggleEquip} onDelete={async (id) => {if(confirm('×œ××—×•×§?')){const u = checkouts.filter(x=>x.id!==id); setCheckouts(u); await storage.save('checkouts', u);}}}/>}
                        {view === 'faults' && <FaultsView faults={faults} onStatus={onFaultStatus} />}
                        {view === 'report' && <Report checkouts={checkouts} faults={faults} />}
                        {view === 'links' && <Links />}
                    </main>
                </div>
            );
        }

        function Dashboard({ checkouts, onUpdate, onToggle, onDelete }) {
            const EditCell = ({ val, onSave }) => {
                const [e, setE] = useState(false);
                const [v, setV] = useState(val);
                if (!e) return <td className="editable" onClick={() => setE(true)}>{val || '-'}</td>;
                return <td><input autoFocus value={v} onChange={x => setV(x.target.value)} onBlur={() => {onSave(v); setE(false);}} onKeyDown={x => x.key === 'Enter' && x.target.blur()} /></td>;
            };

            return (
                <div>
                    {UNITS.map(unit => {
                        const rows = checkouts.filter(c => c.unit === unit);
                        if (rows.length === 0) return null;
                        return (
                            <div key={unit}>
                                <h2 style={{color:'#2c5f2d', borderBottom:'2px solid'}}>{unit}</h2>
                                <div style={{overflowX:'auto'}}>
                                    <table>
                                        <thead><tr><th>×ª×¤×§×™×“</th><th>×©×</th><th>×.×</th><th>624</th><th>×œ×™×•× ×˜</th><th>××˜×¢×Ÿ</th><th>××¢×“</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                                        <tbody>
                                            {rows.map(r => (
                                                <tr key={r.id}>
                                                    <EditCell val={r.role} onSave={v => onUpdate(r.id, 'role', v)} />
                                                    <EditCell val={r.soldierName} onSave={v => onUpdate(r.id, 'soldierName', v)} />
                                                    <EditCell val={r.soldierId} onSave={v => onUpdate(r.id, 'soldierId', v)} />
                                                    <td onClick={() => onToggle(r.id, 'radio624')} className="editable">{r.equipment?.radio624 ? 'âœ“' : '-'}</td>
                                                    <td onClick={() => onToggle(r.id, 'lionet')} className="editable">{r.equipment?.lionet ? 'âœ“' : '-'}</td>
                                                    <td onClick={() => onToggle(r.id, 'charger')} className="editable">{r.equipment?.charger ? 'âœ“' : '-'}</td>
                                                    <td onClick={() => onToggle(r.id, 'vest')} className="editable">{r.equipment?.vest ? 'âœ“' : '-'}</td>
                                                    <td><button className="btn btn-danger" onClick={() => onDelete(r.id)}>××—×§</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function FaultsView({ faults, onStatus }) {
            const pending = faults.filter(f => f.status === 'pending');
            const resolved = faults.filter(f => f.status === 'resolved');
            const getTime = (d) => {
                const diff = Math.floor((new Date() - new Date(d)) / 60000);
                if (diff < 60) return `${diff} ×“×§×•×ª`;
                if (diff < 1440) return `${Math.floor(diff/60)} ×©×¢×•×ª`;
                return `${Math.floor(diff/1440)} ×™××™×`;
            };

            return (
                <div>
                    <h2>×ª×§×œ×•×ª ×¤×ª×•×—×•×ª ({pending.length})</h2>
                    {pending.map(f => (
                        <div key={f.id} className="fault-card">
                            <strong>{f.soldierName}</strong> | {f.equipmentType}<br/>
                            {f.description}<br/>
                            <small>× ×¤×ª×— ×œ×¤× ×™: {getTime(f.date)} ({new Date(f.date).toLocaleString('he-IL')})</small><br/>
                            <button className="btn" style={{background:'#4caf50', marginTop:'5px'}} onClick={() => onStatus(f.id, 'resolved')}>âœ“ ×˜×•×¤×œ</button>
                        </div>
                    ))}
                    <h2>×”×™×¡×˜×•×¨×™×” (×˜×•×¤×œ×•)</h2>
                    {resolved.slice().reverse().map(f => (
                        <div key={f.id} className="fault-card fault-resolved">
                            <strong>{f.soldierName}</strong> ×˜×•×¤×œ ×‘: {new Date(f.resolvedDate).toLocaleString('he-IL')}<br/>
                            <button className="btn btn-danger" style={{padding:'4px 8px', fontSize:'0.8rem'}} onClick={() => onStatus(f.id, 'pending')}>â†© ×”×—×–×¨ ×œ×˜×™×¤×•×œ</button>
                        </div>
                    ))}
                </div>
            );
        }

        function Report({ checkouts, faults }) {
            const generate = () => {
                let r = '×“×•×— ×¦\n*×¤×œ×•×’×” ×›×³*\n\n';
                UNITS.forEach(unit => {
                    const soldiers = checkouts.filter(c => c.unit === unit);
                    if (soldiers.length === 0) return;
                    r += `${unit}:\n`;
                    soldiers.forEach(s => {
                        const last4 = s.soldierId?.toString().slice(-4) || '????';
                        const role = (s.role || '').toLowerCase();
                        let prefix = '';
                        if (role === '××') prefix = '××´× ';
                        else if (role === '××¤') prefix = '××´×¤ ';
                        else if (role === '×¡××¤') prefix = '×¡××´×¤ ';
                        r += `  ${prefix}${last4}\n`;
                    });
                    r += '\n';
                });
                return r;
            };
            return (
                <div>
                    <h2>×“×•×— ×™×•××™ ××•×˜×•××˜×™</h2>
                    <div className="report-preview">{generate()}</div>
                    <button className="btn" style={{marginTop:'10px', background:'#2c5f2d'}} onClick={() => {navigator.clipboard.writeText(generate()); alert('×”×•×¢×ª×§');}}>ğŸ“‹ ×”×¢×ª×§ ×“×•×—</button>
                </div>
            );
        }

        function Links() {
            const baseUrl = "https://maorshitrit0-oss.github.io/plugat-kaf-equipment-";
            return (
                <div>
                    <h2>×§×™×©×•×¨×™× ×œ××¢×¨×›×ª</h2>
                    <p>×—×ª×™××”: {baseUrl}/soldier-signup-UPDATED.html</p>
                    <p>×ª×§×œ×•×ª: {baseUrl}/fault-report-UPDATED.html</p>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
